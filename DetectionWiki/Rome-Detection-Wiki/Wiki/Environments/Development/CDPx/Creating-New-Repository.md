# Creating new CDPx repository

## Creating a new repo

Steps to create and configure a new repository are [here](https://onebranch.visualstudio.com/Pipeline/_wiki/wikis/Pipeline.wiki?pagePath=%2FCDPx%20%252D%20Cross%252DPlatform%20Cloud%20Delivery%20Pipeline%2FUsage%2FRepository%20Setup&wikiVersion=GBwikiMaster&pageId=313)

## Steps

Although it is advised to read the online wiki in case its content was updated. I'll try to summarize here key items from this wiki page:

1. Create a new repository by using the ["New Goverened Repository" in OneBranch](https://dev.azure.com/msazure/One/_apps/hub/EZStart.easy-start-ux.onebranch-repository-creation)
	- Note to select 'None' as the repository template, otherwise you will get CDPx template files by PIE engineering which are not relevant for us
	- Use *746de784-6763-44d9-bc6c-e54b6bd62944* as the service tree id

2. Once the repository is created, open it and select branches view to set you the right edit policies permissions:
	- Go to the branch view in the repository
	- Click on branch security on the master branch
	- Select your account and set allow to edit branch policies

3. Add your repo as a valid product to service tree through Compliance -> Products (you might need to ask a privileged admin from your team to do so).
	- You will need to wait 24 hours following this step before being able to create build definition on this repository
	
4. Add a Nuget.config file to point to the source feeds at the root of your repository. [Sample file](https://dev.azure.com/msazure/One/_git/Rome-Detection-SFMonitoringAgent?path=%2FNuGet.config)

5. Build versioning:
	In case you are going with vanilla msbuild/dotnet code, than there is not autogenerated assembly info in local compilation which gets added to each csproj as in CBT/CoreXT, instead the convention is to create a .version folder under the repo root and place a file called PipelineAssemblyInfo.cs in it with the following contents:

	```cs
	// This is a CDP xPlat pipeline     generated file
	using System.Reflection;
	[assembly: AssemblyVersion("1.0.0.0")]
	[assembly: AssemblyFileVersion("1.0.0.0")]
	[assembly: AssemblyInformationalVersion ("1.0.0.0-dev-00000000")]
	```
		
	- This is a placeholder file and will be overridden when running a server side build by CDPx.
	- Make sure to link to this file in all of your projects. More info on this stage can be read 
    [here](https://dev.azure.com/onebranch/Pipeline/_wiki/wikis/Pipeline.wiki/313/Repository-Setup), 
    the wiki page for CDPx versioning is 
    [here](https://dev.azure.com/onebranch/Pipeline/_wiki/wikis/Pipeline.wiki/325/Versioning)
		
6. Add **.gitignore** file to the repository. Sample recommended file to start with is this [one](https://dev.azure.com/msazure/One/_git/Rome-Shared-ADF-DatasetPublishActivity?path=%2F.gitignore&version=GBmaster)
	
7. Add **global.json** file to the repository root to enable csproj file with no target SDK (for deployment projects): [file](https://dev.azure.com/msazure/One/_git/Rome-Detection-SFMonitoringAgent?path=%2Fglobal.json)
	
8. Add sample code to the repository under src folder.
	- Note that once you link the version/PipelineAssemblyInfo.csfile to your project, build willfail. To fix that, add thefollowing lines to the csproj:

        ```xml
	    <GenerateAssemblyVersionAttribute>alse<GenerateAssemblyVersionAttribute>

	    <GenerateAssemblyFileVersionAttribte>false<GenerateAssemblyFileVersionAttribue>

	    <GenerateAssemblyInformationalVersonAttribute>false<GenerateAssemblyInformationalVersinAttribute>
        ```

9. In case you have a nuproj, import the following targets file inside:
	$(REPO_ROOT)\RepoTemplate\Targets\SetPackageVersion.targets
		
10. Add Rome-Shared-RepoTemplate as submodule to the repository: 
	- The rome repository template includes common scripts that are used by each of the repositories pipeline yml files, which makes the onboarding to CDPx much easier.
	- Including the repository template as part of your repo should be done by a submodule linked to the **Rome-Shared-RepoTemplate** repository and cloned to the RepoTemplate directory under the repo's root folder.
	- You can do it by running these commands:
	
        ```
    	git submodule add https://dev.azure.com/msazure/One/_git/Rome-Shared-RepoTemplate RepoTemplate
	
    	git submodule update --init --recursive
        ```
		

11. Add the configuration file to onboard to TSA:
	[CDPx TSA wiki](https://dev.azure.com/onebranch/Pipeline/_wiki/wikis/Pipeline.wiki/1074/SDL-Bugfiling-(TSA))
	
    Create a file called .config/tsaoptions.json with the following content:
    ```json
	{
	    "AreaPath": "One\\Rome\\Fundamentals\\SecurityBugs\\TSA",
	    "NotificationAliases": [
	        "RomeDetectionEng@microsoft.com"
	    ]
	}
    ```
	
12. Add pipeline yml file that will orchestrate the build environment. The build is based on docker containers, hence the format of the files and how to run the different steps in the build.

    Example [pipeline.user.windows.yml](https://dev.azure.com/msazure/One/_git/Rome-Shared-ADF-DatasetPublishActivity?path=%2F.pipelines%2Fpipeline.user.windows.yml&version=GBpipelines) file
		
	- By convention all pipeline definition are placed in the .pipelines folder at the root of the repository
	- The file name should be 
    ```
    pipeline.user.<os>.<buildtype>.yml 
    ```
    or
    ```
    pipeline.user.<os>.yml
    ```

    - The values of OS are implicit and can only be linux or windows.
	- The values of Build Type can only be one of official, pullrequest or buddy
	
13. Next thing is to configure a build definition for CDPx in VSTS:
	- Click on Pipeline->OneBranch Pipeline.
	- Select your repository (it might take two times to properly select it).
	- Pick master branch.
	- Pick buddy build for now, later do the same process for pull request and official build types.
    - use CDPX-Windows-Pipelines-1809-D16s-v3 as the image (this might change, occasionally, so confirm).
	- Make sure the checkbox to skip the creation of sample files (pipeline yml) is **checked** - as you already have those files checked in.
		
	You can change build definition after you created it [here](https://onebranchhub-dev.azurewebsites.net/msazure/one/BuildDefinition)
	

## Deprecation:
In case one does not want to use the repo template **NOT SUGGESTED**

Add the build scripts that will restore nugets and build your solution, these should be included as part of the CDPx workflow that will be created.
Usually these files are saved as .build/build.cmd and .build/restore.cmd under the repository:

- Build.cmd
- Restore.cmd
- Test.cmd
- Test.ps1
		
Note: to edit the solution file name in these files. You might also want to add a package.cmd file in case your code does any packaging (e.g. cloud service)